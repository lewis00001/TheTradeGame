<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradingGame</title>
    <style>
        #player-items { 
            display: inline-block;
        }
        .trade-data-divs {
            border: 1px solid black;
            padding: 1em;
            width: 350px;
            margin: 20px 2px 0 2px;
        }
        .data-output-divs {
            display: flex;
            flex-direction: row;
        }
        .trader-section {
            padding: 1em;
            background-color: #ddd;
            display: flex;
            justify-content: space-around;
        }
        .trader {
            min-width: 80px;
            min-height: 120px;
            padding: 0.5em;
            background-color: #aaa;
            display: flex;
            justify-content: center;
            flex-direction: column;
        }
        .trader-title, .t-h4 {
            text-align: center;
        }
        .trader-img {
            width: 200px;
            margin: 0 auto;
        }
        .data-heading {
            font-weight: 800;
            padding-bottom: 4px;
        }
        .data-row {
            display: flex;
            justify-content: space-between;
        }
        .data-cell {
            min-width: 70px;
        }
        .button-options {
            margin: 0 auto 10px auto;
        }
    </style>
</head>
<body>
    <h2>Trading Game</h2>
    <h3 class="instructions">The information on how to play the game will be here at some point.</h3>

    <div class="trader-section" id="trader-section">
        <div class="trader" id="trader-1">
            <h3 class="trader-title">Trader-1: Alef</h3>
            <img class="trader-img" src="./img/trader-1.jpg">
            <h4 class="t-h4">What would you like to trade?</h4>

            <form action="javascript:processTrader1()" class="trade-form" id="form-t1">
                <input type="hidden" id="trader-name-t1" value="Alef">
                <select name="items-for-trade" id="items-for-trade-t1" required>
                    <option value="">--choose an item--</option>
                    <option value="salt">Salt</option>
                    <option value="gems">Gems</option>
                    <option value="wool">Wool</option>
                    <option value="oil">Oil</option>
                    <option value="spices">Spices</option>
                    <option value="furs">Furs</option>
                    <option value="jade">Jade</option>
                    <option value="silk">Silk</option>
                </select>
                <input type="number" class="trader-input" id="trade-qty-t1" placeholder="qty"
                    required="required" min="0" step="1" max="20">
                <input type="submit">
            </form>
        </div>

        <div class="trader" id="trader-2">
            <h4 class="trader-title">Trader 2 - Lamed</h4>
            <img class="trader-img" src="./img/trader-2.jpg">
            <h4 class="t-h4">What would you like to trade?</h4>

            <form action="javascript:processTrader2()" class="trade-form" id="form-t2">
                <input type="hidden" id="trader-name-t2" value="Lamed">
                <select name="items-for-trade" id="items-for-trade-t2" required>
                    <option value="">--choose an item--</option>
                    <option value="salt">Salt</option>
                    <option value="gems">Gems</option>
                    <option value="wool">Wool</option>
                    <option value="oil">Oil</option>
                    <option value="spices">Spices</option>
                    <option value="furs">Furs</option>
                    <option value="jade">Jade</option>
                    <option value="silk">Silk</option>
                </select>
                <input type="number" class="trader-input" id="trade-qty-t2" placeholder="qty"
                    required="required" min="0" step="1" max="20">
                <input type="submit">
            </form>
        </div>

        <div class="trader" id="trader-3">
            <h4 class="trader-title">Trader 3 - Samech</h4>
            <img class="trader-img" src="./img/trader-3.jpg">
            <h4 class="t-h4">What would you like to trade?</h4>

            <form action="javascript:processTrader3()" class="trade-form" id="form-t3">
                <input type="hidden" id="trader-name-t3" value="Samech">
                <select name="items-for-trade" id="items-for-trade-t3" required>
                    <option value="">--choose an item--</option>
                    <option value="salt">Salt</option>
                    <option value="gems">Gems</option>
                    <option value="wool">Wool</option>
                    <option value="oil">Oil</option>
                    <option value="spices">Spices</option>
                    <option value="furs">Furs</option>
                    <option value="jade">Jade</option>
                    <option value="silk">Silk</option>
                </select>
                <input type="number" class="trader-input" id="trade-qty-t3" placeholder="qty"
                    required="required" min="0" step="1" max="20">
                <input type="submit">
            </form>
        </div>
    </div>

    <div class="rumor" id="rumor"></div>

    <div class="data-output-divs">
        <div class="trade-data-divs">
            <h4>Player Trade Items</h4>
            <div class="data-heading data-row">
                <div class="data-cell">Item</div>
                <div class="data-cell">Quantity</div>
            </div>
            <hr>
            <div id="player-items-output"></div>
        </div>
    
        <div class="trade-data-divs">
            <h4>Trade History</h4>
            <div class="data-heading data-row">
                <div class="data-cell">Turn</div>
                <div class="data-cell">Trader</div>
                <div class="data-cell">Item</div>
                <div class="data-cell">Price</div>
                <div class="data-cell">Quantity</div>
            </div>
            <hr>
            <div id="trade-history-output"></div>
        </div>
    </div>

    <script>

        function gameStart() {
            purgeTradeHistory();
            getTurnTrades();
            getRumors();
        }
        gameStart();

        // trade history needs to be reset for each game
        async function purgeTradeHistory() {
            // delete trade history table
            const del = await fetch('/purgeTable/trade_history')
                .then(del => del.text())
                .then(text => console.log(text)
            );
        }

        // this tracks the current turn and is used to calculate trade bonuses
        let currentTurn = 1;
        const maxTurns = 24;
        // get the turn trade information and store it a const
        const turnTrades = [];
        // get the rumors information and store it a const
        const rumors = [];

        // get turn trades and add them to a global var
        async function getTurnTrades() {
            const res = await fetch('/getTableData/turn_trades');
            const data = await res.json();
            data.elements.forEach(element => {
                let obj = {};
                obj['turn'] = element.turn;
                obj['item'] = element.item;
                obj['alefBonus'] = element.alef_bonus;
                obj['lamedBonus'] = element.lamed_bonus;
                obj['samechBonus'] = element.samech_bonus;
                turnTrades.push(obj);
            });
            getCurrentTurnTrade();
        }

        // get rumors and add them to a global var
        async function getRumors() {
            const res = await fetch('/getTableData/rumors');
            const data = await res.json();
            data.elements.forEach(element => {
                let obj = {};
                obj['turn'] = element.turn;
                obj['rumor'] = element.rumor;
                rumors.push(obj);
            });
            displayRumor();
        }

        const turnRumor = document.getElementById('rumor');
        function displayRumor() {
            const noRumor = ['I have heard nothing.', 'I have been asking around.', 'Do we need to trade today?', 'Finding a lead will take time.'];
            let heardRumor = Math.random() < 0.5;
            // if heardRumor is true, display from global rumors
            if (heardRumor) {
                turnRumor.innerText = rumors[currentTurn - 1].rumor;
            // if heardRumor was false, present an excuse from noRumorSelection
            } else {
                // select randome number between 0 and 3
                let noRumorSelection = Math.floor(Math.random() * (3 - 0 + 1)) + 0;
                turnRumor.innerText = noRumor[noRumorSelection];
            }
        }
        
        function getCurrentTurnTrade() {
            console.log(turnTrades[currentTurn - 1].turn);
        }

        // process trade
        const tradeHistory = document.getElementById('trade-history-output');

        // trader 1
        function processTrader1() {
            // get values from form
            const traderName = document.getElementById('trader-name-t1').value;
            const itemsForTrade = document.getElementById('items-for-trade-t1').value;
            const tradeQty = document.getElementById('trade-qty-t1').value;
            updateTradeHistory(traderName, itemsForTrade, tradeQty);
            document.getElementById('form-t1').reset();
        }
        // trader 2
        function processTrader2() {
            // get values from form
            const traderName = document.getElementById('trader-name-t2').value;
            const itemsForTrade = document.getElementById('items-for-trade-t2').value;
            const tradeQty = document.getElementById('trade-qty-t2').value;
            updateTradeHistory(traderName, itemsForTrade, tradeQty);
            document.getElementById('form-t2').reset();
        }
        // trader 3
        function processTrader3() {
            // get values from form
            const traderName = document.getElementById('trader-name-t3').value;
            const itemsForTrade = document.getElementById('items-for-trade-t3').value;
            const tradeQty = document.getElementById('trade-qty-t3').value;
            updateTradeHistory(traderName, itemsForTrade, tradeQty);
            document.getElementById('form-t3').reset();
        }

        async function updateTradeHistory(traderName, itemsForTrade, tradeQty) {
            // ensure data is passed to function
            console.log(`Trade Details: ${traderName}: ${itemsForTrade}: ${tradeQty}`);
            // insert new data to trade history
            console.log(`current turn: ${currentTurn}`);
            const res = await fetch(`/addToTradeHistory/${currentTurn}&${traderName}&${itemsForTrade}&${5}&${tradeQty}`)
                .then(res => res.text())
                .then(text => console.log(text)
            );
            updateCurrentTurnCount();
            displayTradeHistoryData();
            displayRumor();
        }

        function updateCurrentTurnCount() {
            if(currentTurn <= maxTurns) {
                currentTurn++;
            } else {
                triggerEndGame();
            }
        }

        function triggerEndGame() {
            alert("You've reached you max amount of turns. Game over!");
        }

        // update trade history on the html page
        async function displayTradeHistoryData() {
            // clear table contents
            tradeHistory.innerHTML = '';
            // get new trade history data
            const res2 = await fetch(`/getTableData/trade_history`);
            const data = await res2.json();
            data.elements.forEach(element => {
                // loop through all returned items and output them to the UI
                // create containing div
                let container = document.createElement('div');
                container.setAttribute('class', 'data-row');
                tradeHistory.appendChild(container);
                // create turn div and append to container
                let turnDiv = document.createElement('div');
                turnDiv.setAttribute('class', 'data-cell');
                turnDiv.appendChild(document.createTextNode(element.turn));
                container.appendChild(turnDiv);
                // create trader name div and append to container
                let nameDiv = document.createElement('div');
                nameDiv.setAttribute('class', 'data-cell');
                nameDiv.appendChild(document.createTextNode(element.trader_name));
                container.appendChild(nameDiv);
                // create quantity div and append to container
                let tradeItemDiv = document.createElement('div');
                tradeItemDiv.setAttribute('class', 'data-cell');
                tradeItemDiv.appendChild(document.createTextNode(element.item));
                container.appendChild(tradeItemDiv);
                // create quantity div and append to container
                let sellPriceDiv = document.createElement('div');
                sellPriceDiv.setAttribute('class', 'data-cell');
                sellPriceDiv.appendChild(document.createTextNode(element.sell_price_per_item));
                container.appendChild(sellPriceDiv);
                // create quantity div and append to container
                let numItemsTradedDiv = document.createElement('div');
                numItemsTradedDiv.setAttribute('class', 'data-cell');
                numItemsTradedDiv.appendChild(document.createTextNode(element.num_items_traded));
                container.appendChild(numItemsTradedDiv);
            });
        }

        // display player items
        const playerItems = document.getElementById('player-items-output');
        async function displayPlayerItems() {
            const res = await fetch('/getAllPlayerItems');
            const data = await res.json();
            data.elements.forEach(element => {
                // loop through all returned items and output them to the UI
                // create containing div
                let container = document.createElement('div');
                container.setAttribute('class', 'data-row');
                playerItems.appendChild(container);
                // create name div and append to container
                let nameDiv = document.createElement('div');
                nameDiv.setAttribute('class', 'data-cell');
                nameDiv.appendChild(document.createTextNode(element.item));
                container.appendChild(nameDiv);
                // create quantity div and append to container
                let quantDiv = document.createElement('div');
                quantDiv.setAttribute('class', 'data-cell');
                quantDiv.appendChild(document.createTextNode(element.qty));
                container.appendChild(quantDiv);
            });
        }
        displayPlayerItems();


    </script>
</body>
</html>